(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["uni_modules/almost-lottery/components/almost-lottery/almost-lottery"],{"6f00":function(t,e,i){"use strict";i.r(e);var a=i("7558"),n=i.n(a);for(var r in a)["default"].indexOf(r)<0&&function(t){i.d(e,t,(function(){return a[t]}))}(r);e["default"]=n.a},7558:function(t,e,i){"use strict";(function(t){var a=i("47a9");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=a(i("7eb4")),r=a(i("ee10")),s=i("3a03"),o=t.getSystemInfoSync(),l={name:"AlmostLottery",props:{canvasId:{type:String,default:"almostLotteryCanvas"},canvasWidth:{type:Number,default:242},canvasHeight:{type:Number,default:242},outerWidth:{type:Number,default:267},outerHeight:{type:Number,default:267},canvasMargin:{type:Number,default:0},actionWidth:{type:Number,default:120},actionHeight:{type:Number,default:120},prizeList:{type:Array,required:!0,validator:function(t){return t.length>1}},prizeIndex:{type:Number,required:!0},colors:{type:Array,default:function(){return["#fbe7bb","#fcd68c"]}},lotteryBg:{type:String,default:"/uni_modules/almost-lottery/static/almost-lottery/almost-lottery__bg2x.png"},actionBg:{type:String,default:"/uni_modules/almost-lottery/static/almost-lottery/almost-lottery__action2x.png"},prizeNameDrawed:{type:Boolean,default:!0},stroked:{type:Boolean,default:!1},strokeColor:{type:String,default:"#FFE9AA"},rotateType:{type:String,default:"roulette"},duration:{type:Number,default:8},ringCount:{type:Number,default:8},pointerPosition:{type:String,default:"edge",validator:function(t){return"edge"===t||"middle"===t}},strDirection:{type:String,default:"horizontal"},strFontColor:{type:String,default:"#A62A2A"},strFontSize:{type:Number,default:9},strMarginOutside:{type:Number,default:0},imgMarginStr:{type:Number,default:25},strLineHeight:{type:Number,default:1.2},strKey:{type:String,default:"name"},strMaxLen:{type:Number,default:12},strLineLen:{type:Number,default:6},imgWidth:{type:Number,default:30},imgHeight:{type:Number,default:30},successMsg:{type:String,default:"奖品准备就绪，快来参与抽奖吧"},failMsg:{type:String,default:"奖品仍在准备中，请稍后再来..."},canvasCached:{type:Boolean,default:!1}},data:function(){return{className:"almost-lottery__canvas",lotteryImg:"",targetAngle:0,targetActionAngle:0,transitionDuration:0,isRotate:!1,stayIndex:0,targetIndex:0,isCacheImg:!1,oldLotteryImg:"",almostLotteryTip:"奖品准备中...",measureText:""}},computed:{higtCanvasSize:function(){return this.canvasWidth*o.pixelRatio},higtFontSize:function(){return this.strFontSize*o.pixelRatio},higtHeightMultiple:function(){return this.strFontSize*this.strLineHeight*o.pixelRatio},higtCanvasMargin:function(){return this.canvasMargin*o.pixelRatio},canvasAngle:function(){var t=0,e=this.prizeList.length,i=360/e,a=90/i;return t="edge"===this.pointerPosition||"pointer"===this.rotateType?-i*a:-(i*a+i/2),t},actionAngle:function(){return 0},outsideRadius:function(){return this.higtCanvasSize/2},insideRadius:function(){return 20*o.pixelRatio},textRadius:function(){return this.strMarginOutside*o.pixelRatio||this.higtFontSize/2},textDistance:function(){var t=Math.round(this.outsideRadius-this.insideRadius/2);return t-this.textRadius}},watch:{prizeIndex:function(t,e){t>-1?(this.targetIndex=t,this.onRotateStart()):console.info("旋转结束，prizeIndex 已重置")}},methods:{onRotateStart:function(){var t=this;if(!this.isRotate){this.isRotate=!0;var e=this.prizeList.length,i=360/e,a=0;"pointer"===this.rotateType?(a=0===this.targetActionAngle?(this.targetIndex-this.stayIndex)*i+i/2-this.actionAngle:(this.targetIndex-this.stayIndex)*i,this.stayIndex=this.targetIndex,this.targetActionAngle+=a+360*this.ringCount,console.log("targetActionAngle",this.targetActionAngle)):(a=0===this.targetAngle?270-(this.targetIndex-this.stayIndex)*i-i/2-this.canvasAngle:-(this.targetIndex-this.stayIndex)*i,this.stayIndex=this.targetIndex,this.targetAngle+=a+360*this.ringCount);var n=1e3*this.transitionDuration+100,r=setTimeout((function(){clearTimeout(r),r=null,t.isRotate=!1,t.$emit("draw-end")}),n),s=setTimeout((function(){clearTimeout(s),s=null,t.$emit("reset-index")}),n+50)}},handleActionStart:function(){this.lotteryImg&&(this.isRotate||this.$emit("draw-start"))},onCreateCanvas:function(){var e=this;return(0,r.default)(n.default.mark((function i(){var a,r,l,c,u,d,h,g,f,m,x,p,y,v,I,b,k,S,T,L,z,C,F,w,A,M,P,R,N,D,_,H,W,$,O,B,J,j,q,E,K;return n.default.wrap((function(i){while(1)switch(i.prev=i.next){case 0:a=e.canvasId,r=t.createCanvasContext(a,e),l=e.higtCanvasSize,c=e.higtCanvasSize,u=e.prizeList.length,d=2*Math.PI/u,r.setFontSize(e.higtFontSize),h=0;case 8:if(!(h<u)){i.next=115;break}if(g=e.prizeList[h],f=h*d,r.save(),r.beginPath(),r.arc(.5*l,.5*c,e.outsideRadius,f,f+d,!1),r.arc(.5*l,.5*c,e.insideRadius,f+d,f,!0),2===e.colors.length?r.setFillStyle(e.colors[h%2]):r.setFillStyle(e.colors[h]),r.fill(),e.stroked&&(r.setStrokeStyle("".concat(e.strokeColor)),r.stroke()),m=.5*l+Math.cos(f+d/2)*e.textDistance,x=.5*c+Math.sin(f+d/2)*e.textDistance,r.translate(m,x),r.setFillStyle(e.strFontColor),p=e.strLimit(g[e.strKey]),r.rotate(f+d/2+Math.PI/2),"horizontal"!==e.strDirection){i.next=72;break}if(!p||!e.prizeNameDrawed){i.next=70;break}if(y=(0,s.clacTextLen)(p).realLen,v=y>e.strLineLen,!v){i.next=56;break}for(I="",b="",k=0,S=0;S<p.length;S++)k+=(0,s.clacTextLen)(p[S]).byteLen,k<=2*e.strLineLen?I+=p[S]:b+=p[S];p=I+","+b,T=p.split(","),L=0;case 36:if(!(L<T.length)){i.next=54;break}if(!(r.measureText&&r.measureText(T[L]).width>0)){i.next=43;break}z=r.measureText(T[L]),C=-(z.width/2).toFixed(2),r.fillText(T[L],C,L*e.higtHeightMultiple),i.next=51;break;case 43:return e.measureText=T[L],i.next=46,e.$nextTick();case 46:return i.next=48,e.getTextWidth();case 48:F=i.sent,w=-(F/2).toFixed(2),r.fillText(T[L],w,L*e.higtHeightMultiple);case 51:L++,i.next=36;break;case 54:i.next=70;break;case 56:if(!(r.measureText&&r.measureText(p).width>0)){i.next=62;break}A=r.measureText(p),M=-(A.width/2).toFixed(2),r.fillText(p,M,0),i.next=70;break;case 62:return e.measureText=p,i.next=65,e.$nextTick();case 65:return i.next=67,e.getTextWidth();case 67:P=i.sent,R=-(P/2).toFixed(2),r.fillText(p,R,0);case 70:i.next=92;break;case 72:N=p.split(""),D=0;case 74:if(!(D<N.length)){i.next=92;break}if(!(r.measureText&&r.measureText(N[D]).width>0)){i.next=81;break}_=r.measureText(N[D]),H=-(_.width/2).toFixed(2),r.fillText(N[D],H,D*e.higtHeightMultiple),i.next=89;break;case 81:return e.measureText=N[D],i.next=84,e.$nextTick();case 84:return i.next=86,e.getTextWidth();case 86:W=i.sent,$=-(W/2).toFixed(2),r.fillText(N[D],$,D*e.higtHeightMultiple);case 89:D++,i.next=74;break;case 92:if(!g.image||"vertical"===e.strDirection){i.next=111;break}if(O=/^(https|http)/g,!O.test(g.image)){i.next=105;break}return"","需要处理好下载域名的白名单问题，",console.warn("###当前数据列表中的奖品图片为网络图片，".concat("需要处理好下载域名的白名单问题，","开始尝试下载图片...###")),i.next=100,(0,s.downloadFile)(g.image);case 100:B=i.sent,console.log("处理远程图片",B),B.ok?(J=B.tempFilePath,g.image=J):e.handlePrizeImgSuc({ok:!1,data:B.data,msg:B.msg}),i.next=106;break;case 105:console.log("处理非远程图片",g.image);case 106:j=-e.imgWidth*o.pixelRatio/2,q=e.imgMarginStr*o.pixelRatio,E=e.imgWidth*o.pixelRatio,K=e.imgHeight*o.pixelRatio,r.drawImage(g.image,j,q,E,K);case 111:r.restore();case 112:h++,i.next=8;break;case 115:r.draw(!0,(function(){var i=setTimeout((function(){clearTimeout(i),i=null,t.canvasToTempFilePath({canvasId:e.canvasId,success:function(t){e.handlePrizeImg({ok:!0,data:t.tempFilePath,msg:"画布导出生成图片成功"})},fail:function(t){e.handlePrizeImg({ok:!1,data:t,msg:"画布导出生成图片失败"})}},e)}),500)}));case 116:case"end":return i.stop()}}),i)})))()},handlePrizeImg:function(e){var i=this;if(e.ok){var a=e.data;if(!this.canvasCached)return this.lotteryImg=a,void this.handlePrizeImgSuc(e);this.isCacheImg?t.getSavedFileList({success:function(t){var n=t.fileList,r=!1;if(n.length)for(var s=0;s<n.length;s++){var o=n[s];if(o.filePath===a){r=!0,i.lotteryImg=a,console.info("经查，本地缓存中存在的转盘图可用，本次将不再绘制转盘"),i.handlePrizeImgSuc(e);break}}r||(console.info("经查，本地缓存中存在的转盘图不可用，需要重新初始化转盘绘制"),i.initCanvasDraw())},fail:function(t){i.initCanvasDraw()}}):t.saveFile({tempFilePath:a,success:function(t){var e=t.savedFilePath;(0,s.setStore)("".concat(i.canvasId,"LotteryImg"),e),i.lotteryImg=e,i.handlePrizeImgSuc({ok:!0,data:e,msg:"画布导出生成图片成功"})},fail:function(t){i.handlePrizeImg({ok:!1,data:t,msg:"画布导出生成图片失败"})}})}else console.error("处理导出的图片失败",e),t.hideLoading(),console.error("###当前为小程序端，下载网络图片需要配置域名白名单###")},handlePrizeImgSuc:function(e){t.hideLoading(),this.$emit("finish",{ok:e.ok,data:e.data,msg:e.ok?this.successMsg:this.failMsg}),this.almostLotteryTip=e.ok?this.successMsg:this.failMsg},getTextWidth:function(){console.warn("正在采用兼容方式获取文本的 size 信息，虽然没有任何问题，如果可以，请将此 systemInfo 及 hbx 版本号 反馈给作者",o);var e=t.createSelectorQuery().in(this),i=e.select(".almost-lottery__measureText");return new Promise((function(t,e){i.fields({size:!0},(function(e){t(e.width)})).exec()}))},strLimit:function(t){var e=this.strMaxLen;return t&&e&&(0,s.clacTextLen)(t).realLen>e?t.slice(0,e-1)+"..":t},checkCacheImg:function(){console.log("检查本地缓存中是否存在转盘图"),this.oldLotteryImg=(0,s.getStore)("".concat(this.canvasId,"LotteryImg"));var t=(0,s.getStore)("".concat(this.canvasId,"PrizeList")),e=JSON.stringify(this.prizeList);if(this.oldLotteryImg&&t===e)return console.log("经查，本地缓存中存在转盘图 => ".concat(this.oldLotteryImg)),this.isCacheImg=!0,console.log("需要继续判断这张缓存图是否可用"),void this.handlePrizeImg({ok:!0,data:this.oldLotteryImg,msg:"画布导出生成图片成功"});console.log("经查，本地缓存中不存在转盘图"),this.initCanvasDraw()},initCanvasDraw:function(){console.log("开始初始化转盘绘制"),this.isCacheImg=!1,this.lotteryImg="",(0,s.clearStore)("".concat(this.canvasId,"LotteryImg")),(0,s.setStore)("".concat(this.canvasId,"PrizeList"),this.prizeList),this.onCreateCanvas()}},mounted:function(){var t=this;this.$nextTick((function(){var e=setTimeout((function(){clearTimeout(e),e=null,t.canvasCached?t.checkCacheImg():t.onCreateCanvas(),t.transitionDuration=t.duration}),50)}))}};e.default=l}).call(this,i("df3c")["default"])},"84f8":function(t,e,i){"use strict";var a=i("c535"),n=i.n(a);n.a},b534:function(t,e,i){"use strict";i.d(e,"b",(function(){return a})),i.d(e,"c",(function(){return n})),i.d(e,"a",(function(){}));var a=function(){var t=this.$createElement;this._self._c},n=[]},c535:function(t,e,i){},ce13:function(t,e,i){"use strict";i.r(e);var a=i("b534"),n=i("6f00");for(var r in n)["default"].indexOf(r)<0&&function(t){i.d(e,t,(function(){return n[t]}))}(r);i("84f8");var s=i("828b"),o=Object(s["a"])(n["default"],a["b"],a["c"],!1,null,"5fccbeb2",null,!1,a["a"],void 0);e["default"]=o.exports}}]);
;(global["webpackJsonp"] = global["webpackJsonp"] || []).push([
    'uni_modules/almost-lottery/components/almost-lottery/almost-lottery-create-component',
    {
        'uni_modules/almost-lottery/components/almost-lottery/almost-lottery-create-component':(function(module, exports, __webpack_require__){
            __webpack_require__('df3c')['createComponent'](__webpack_require__("ce13"))
        })
    },
    [['uni_modules/almost-lottery/components/almost-lottery/almost-lottery-create-component']]
]);
